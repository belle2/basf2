Changes in the analysis package
-------------------------------

Variables
+++++++++

* Removed ``nECLClusters`` (:issue:`BII-4476`).
  The number of `ECLClusters` is not a good measure for anything except the age of the input mdst file.
  Recent changes to the handling of ECLClusters and their hypotheses have changed this (already arbitrary) 
  number to another (equally arbitrary buut different) number.

  .. hint::
	For most common use cases, the recommended alternative is the total number of photons
        (unique photon hypothesis clusters) in the event:

	.. code-block:: python

		from variables import variables
		from stdPhotons import stdPhotons
		stdPhotons("cdc", path=mypath) # creates the all and cdc lists
                variables.addAlias("nPhotonsAll", "nParticlesInList(gamma:all)")
                variables.addAlias("nPhotonsCDC", "nParticlesInList(gamma:cdc)")
                variables.addAlias("totalPhotonEECL", "totalEnergyOfParticlesInList(gamma:all)")

* Deprecated :b2:var:`clusterHypothesis` following changes to the ECLCluster storage on mdst. 
  Please use :b2:var:`clusterHasNPhotons` and :b2:var:`clusterHasNeutralHadron`.

* Removed ClusterHadronIntensity and clusterUniqueID.

* Added helix extrapolation from charged tracks

* Added clusterMdstIndex variable to get ECLCluster MDST index for particles that do not originate from ECLCluster

* The function to create variable aliases for particles selected from a decay
  string has been fixed and extended to allow better
  customization (:issue:`BII-4437`)

  .. seealso::
     `variables.utils.create_aliases_for_selected()`

* Added M2, that returns the invariant mass squared of a given Particle (determined from the particle's 4-momentum vector).

* Added eclClusterOnlyInvariantMass, that returns the invariant mass of the particles, computed with cluster information

* Added :b2:var:`grandDaughterDiffOf`,  :b2:var:`grandDaughterDiffOfPhi`, and  :b2:var:`grandDaughterDiffOfClusterPhi`.
  They behave like :b2:var:`daughterDiffOf`, but use grandDaughters' information rather than daughters'.

* Renamed ClusterHasPulseShapeDiscrimination to :b2:var:`clusterHasPulseShapeDiscrimination`, PulseShapeDiscriminationMVA to :b2:var:`clusterPulseShapeDiscriminationMVA`, and ClusterNumberOfHadronDigits to :b2:var`clusterNumberOfHadronDigits`.

* Added MC flight information variables, :b2:var:`mcFlightDistance` and :b2:var:`mcFlightTime`

Standard Particle Lists
+++++++++++++++++++++++

* Updated charged standard PID cut values to reflect the correct efficiencies.
  This recovers the efficiency loss reported in :issue:`BIIDP-1065`.

* Fix the `stdKlongs.stdKlongs` lists.

* The variables for the fast reco HLT trigger stage have been removed,
  as we are currently not planning to have it in the early data taking.

Modules
+++++++

* Fixed a bug in the :b2:mod:`BestCandidateSelection` module: When
  ``allowMultiRank=True`` there always at least two candidates with rank of one,
  even if they didn't have the same variable value (:issue:`BII-4460`)

  This affects all users of `modularAnalysis.rankByLowest()` and
  `modularAnalysis.rankByHighest()` if they passed ``allowMultiRank=True``

* Fixed a bug in the :b2:mod:`BestCandidateSelection` module: now the
  ``numBest`` parameter works as expected. 

* Removal of the unsupported ECLClusterInfoModule.

* Added `modularAnalysis.fitPseudo` function and a pseudo vertex fitting module to add a covariance matrix when a vertex fit is not possible. E.g. for :math:`\pi^0` decays.

* Added the new module SignalSideVariablesToDaughterExtraInfoModule. It adds
  ExtraInfo to a specified particle (typically a daughter on the signal side).
  The corresponding information is calculated in the RestOfEvent so it is
  supposed to be executed only in for_each ROE paths.

* Fixed a bug and extended the functionality of the :b2:mod:`RestOfEventBuilder` module.
  When providing a ParticleList of composite particles as an additional source
  for building the ROE, the composite particles are now decomposed and their
  final state daughters are added to the ROE (unless they are part of the
  signal side or already present in the ROE). Previously, composite particles
  were not decomposed and the first composite particle of the first
  ParticleList of composite particles (and only this one) was always added to
  the ROE.
* The module VertexFitUpdateDaughtersModule updates now the daughters always. 

FEI
+++

* Removed the backward compatibility layer (``pid_renaming_oktober_2017``). 
  Only FEI trainings from release-02 are supported. Please update to ``FEIv4_2018_MC9_release_02_00_01`` or newer.

Flavor Tagger
+++++++++++++

* BtagToWBosonVariables adapted to work with the new ROE.
* New default global tag for weight files is analysis_tools_release-03-01-00.
* All release validation and performance evaluation scripts added to analysis/release-validation/CPVTools/.
* The flavor tagger creates and adds default aliases into the collection list flavor_tagging.
* Nightly validation files updated test6_CPVAnalysisTools.py.
* All example scripts use now variablesToNtuples and follow the current syntax and path rules.
* Sphinx documentation is uptodate.
* Added first set of unit tests

Tutorials
+++++++++

* Fix B2A202 to load Klongs as advertised.
* Fix B2A801 to use JPsiKs as signal channel and to show how to run on Belle data/MC. Central database global tag updated.
