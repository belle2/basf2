#+
# File: Makefile.common.in
# Description : Makefile Template
#-

# System Specifications
#    --- Do not change without knowledge

# Compiler Setup with machine dependence

#MODULES +=
#OBJS +=
#LIBS +=
#CERNLIBS +=

FC = @FC@
CC = @CC@
CXX = @CXX@

DEFS = @DEFS@ -DCERNLIB_TYPE
CPPFLAGS = @CPPFLAGS@
DEPCPPFLAGS = @DEPCPPFLAGS@

FFLAGS = @FFLAGS@
CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@
SOFLAGS = @SOFLAGS@
LDFLAGS = @LDFLAGS@

SYSLIB = @SYSLIB@

CLHEPLIB = @CLHEP_LIBS@

MOTIF_LIBS = @MOTIF_LIBS@

POSTGRESINC = @POSTGRES_INCLUDE_DIR@

LINUX_G77_BUG = @LINUX_G77_BUG@

ifneq "$(CERNLIBS)" ""
  ifeq "$(CERN)/$(CERN_LEVEL)" "/"
    CERNLIB_LIB_DIR = @CERNLIB_LIB_DIR@
    CERN_INCLUDE = @CERNLIB_INC_DIR@
  else
    CERNLIB_LIB_DIR = $(CERN)/$(CERN_LEVEL)/lib
    CERN_INCLUDE = $(CERN)/$(CERN_LEVEL)/include
  endif
  CERNLIB = -L$(CERNLIB_LIB_DIR)/so -L$(CERNLIB_LIB_DIR) $(CERNLIBS:%=-l%) $(MOTIF_LIBS)
endif

ifeq "$(MY_TOP_DIR)" ""
  LINK_LIBS = -L$(BELLE_LIB_DIR)/so $(LIBS:%=-l%)
  INCLUDES_C = $(BELLE_TOP_DIR)/include $(CLHEPINC) $(POSTGRESINC)
  INCLUDES_FORTRAN = $(BELLE_TOP_DIR)/inc $(CERN_INCLUDE)
  BUILD_TOP_DIR = $(BELLE_TOP_DIR)
else
  LINK_LIBS = -L$(MY_LIB_SO_DIR) -L$(BELLE_LIB_DIR)/so $(LIBS:%=-l%)
  INCLUDES_C = $(MY_TOP_DIR)/include $(BELLE_TOP_DIR)/include $(CLHEPINC) $(POSTGRESINC)
  INCLUDES_FORTRAN = $(MY_TOP_DIR)/inc $(BELLE_TOP_DIR)/inc $(CERN_INCLUDE)
  BELLE_CONFIG_DIR = $(MY_TOP_DIR)/src/config
  BUILD_TOP_DIR = $(MY_TOP_DIR)
endif

ifneq "$(OBJS)" ""
  PACKAGE = $(shell basename $(shell pwd))
#  LINK_LIBS += -L. $(PACKAGE:%=-l%)
  BUILD_SO = libs
endif

ifneq "$(MAINS)" ""
  BUILD_MAINS = mains
endif

# Dependence description

COMPILE_FCPP := $(FC) -c $(PANTHER_FMACROS) $(INCLUDES_FORTRAN:%=-I%) $(CPPFLAGS) $(FFLAGS)
COMPILE_FC := $(FC) -c  $(INCLUDES_FORTRAN:%=-I%) $(FFLAGS)
COMPILE_CC := $(CC) -c  $(PANTHER_CMACROS) $(INCLUDES_C:%=-I%) $(CPPFLAGS) $(CFLAGS)
COMPILE_CXX := $(CXX) -c  $(PANTHER_CMACROS) $(INCLUDES_C:%=-I%) $(CPPFLAGS) $(CXXFLAGS)

LINK_FCPP := $(FC)
LINK_FC := $(FC)
LINK_CC := $(CC)
LINK_CXX := $(CXX)

DEPEND_FCPP := @DEPEND_FCPP@ $(DEFS) $(PANTHER_FMACROS) $(INCLUDES_FORTRAN:%=-I%) $(CPPFLAGS) $(filter-out -KPIC -Nq1000,$(CFLAGS))
DEPEND_CC := $(CC) $(DEPCPPFLAGS) $(DEFS) $(PANTHER_CMACROS) $(INCLUDES_C:%=-I%) $(CPPFLAGS) $(filter-out -fPIC -KPIC,$(CFLAGS))
DEPEND_CXX := $(CXX) $(DEPCPPFLAGS) $(DEFS) $(PANTHER_CMACROS) $(INCLUDES_C:%=-I%) $(CPPFLAGS) $(filter-out -fPIC -KPIC,$(CXXFLAGS))

%.o:%.c
	$(COMPILE_CC) $<

%.d:%.c
	$(SHELL) -ec '$(DEPEND_CC) $< | sed -e "s/$*\.o[ :]*/$@ &/g" > $@'

%.o:%.cc
	$(COMPILE_CXX) $<

%.d:%.cc
	$(SHELL) -ec '$(DEPEND_CXX) $< | sed -e "s/$*\.o[ :]*/$@ &/g" > $@'

%.o:%.f
	$(COMPILE_FC) $<

%.d:%.f
	$(ATMARK)-$(SHELL) -ec '$(DEPEND_FCPP) $< | sed $(LINUX_G77_BUG) -e "s/$*\.o[ :]*/$@ &/g" > $@'

%.o:%.F
	$(COMPILE_FCPP) $<

%.d:%.F
	$(ATMARK)-$(SHELL) -ec '$(DEPEND_FCPP) $< | sed $(LINUX_G77_BUG) -e "s/$*\.o[ :]*/$@ &/g" > $@'

%.so:%.o $(OBJS:%=%.o)
	$(LINK_CXX) -o $@ $(SOFLAGS) $< $(OBJS:%=%.o) $(LINK_LIBS) $(CERNLIB) $(SYSLIB)

%:%.o $(OBJS:%=%.o)
	$(LINK_CXX) -o $@ $< $(OBJS:%=%.o) $(LINK_LIBS) $(CERNLIB) $(SYSLIB)

.PHONY: all modules shared mains clean

# Dependencies

all: $(OBJS:%=%.o) $(MODULES:%=%.o) $(MODULES:%=%.so) $(MAINS)

modules: $(OBJS:%=%.o) $(MODULES:%=%.o) $(MODULES:%=%.so)

shared: $(OBJS:%=%.o)
	$(LINK_CC) -o lib$(PACKAGE).so $(SOFLAGS) $(OBJS:%=%.o)

mains: $(OBJS:%=%.d) $(MAINS:%=%.d) $(OBJS:%=%.o) $(MAINS:%=%.o) $(MAINS)


clean:
	-rm -f $(wildcard *.o *.d *~ fort.* fpda_pid.* fpda_spy.hbook out log last.kumac* paw.metafile)

ifneq ($(MAKECMDGOALS),clean)
  ifneq "$(OBJS)" ""
    -include $(OBJS:%=%.d)
  endif

  ifneq "$(MODULES)" ""
    -include $(MODULES:%=%.d)
  endif

  ifneq "$(MAINS)" ""
    -include $(MAINS:%=%.d)
  endif
endif
