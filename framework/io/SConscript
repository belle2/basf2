#!/usr/bin/env python
# -*- coding: utf-8 -*-

Import('env')

env['SUBLIB'] = True
env['LIBS'] = ['framework', '$ROOT_LIBS']

import subprocess
import os

# combined commit ID
identifier = None
# local modifications?
modifications = False

# find out what we think the release is
release_version = 'HEAD'
release_commit = None
if 'BELLE2_RELEASE' in os.environ:
    release_version = os.environ['BELLE2_RELEASE']
if release_version.lower() == 'head':
    release_version = 'HEAD'

# check .git to confirm
head_commitid = dict()
release_dir_vars = ['BELLE2_LOCAL_DIR', 'BELLE2_RELEASE_DIR']
for var in release_dir_vars:
    if var not in os.environ:
        continue
    with open(os.devnull, 'w') as devnull:
        proc = subprocess.Popen(['git', '-C', os.environ[var], 'rev-parse', 'HEAD'], stdout=subprocess.PIPE, stderr=devnull)
        head_commitid[var] = proc.communicate()[0].strip()
        if proc.returncode != 0 or len(head_commitid[var]) != 40:
            # release dir is set, but we couldn't get a commit id -> not tracked
            identifier = ""
            continue

        # check for modifications, ignoring untracked files
        proc = subprocess.Popen(['git', '-C', os.environ[var], 'status', '-uno', '--porcelain'], stdout=subprocess.PIPE, stderr=devnull)
        changes = proc.communicate()[0].strip()
        if len(changes) != 0:
            modifications = True

        # get hash for release_version (if set)
        if release_commit is not None or release_version == 'HEAD':
            continue
        proc = subprocess.Popen(['git', '-C', os.environ[var], 'rev-parse', release_version], stdout=subprocess.PIPE, stderr=devnull)
        release_commit = proc.communicate()[0].strip()
        if proc.returncode != 0 or len(release_commit) != 40:
            # unsure why this would fail, but whatever
            release_commit = None
        elif release_commit == head_commitid[var]:
            head_commitid[var] = release_version

if identifier is None:
    if len(head_commitid) == 2:
        if head_commitid['BELLE2_RELEASE_DIR'] != head_commitid['BELLE2_LOCAL_DIR']:
            identifier = head_commitid['BELLE2_RELEASE_DIR'] + '+' + head_commitid['BELLE2_LOCAL_DIR']
        else:
            identifier = head_commitid['BELLE2_RELEASE_DIR']
    elif 'BELLE2_RELEASE_DIR' in head_commitid:
        identifier = head_commitid['BELLE2_RELEASE_DIR']
    elif 'BELLE2_LOCAL_DIR' in head_commitid:
        identifier = head_commitid['BELLE2_LOCAL_DIR']
    else:
        print('both central & local dir seem not to be git repositories, but we failed to detect this earlier. Please report this.')
        identifier = ''
if identifier != '' and modifications:
    identifier += '-modified'

env.Append(CPPDEFINES={'GIT_COMMITID': '\\"' + identifier + '\\"'})


Return('env')
